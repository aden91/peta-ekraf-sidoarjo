<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Ekraf & Wisata Sidoarjo</title>

    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://api.mapbox.com https://cdnjs.cloudflare.com https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js;
        style-src 'self' 'unsafe-inline' https://api.mapbox.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:;
        img-src 'self' data: blob: https:;
        connect-src 'self' https://api.mapbox.com https://events.mapbox.com;
        worker-src 'self' blob:;
    ">

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">

    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;600;700;800&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- GLOBAL STYLE --- */
        :root {
            --primary: #4361ee;
            --accent: #3f37c9;
            --danger: #ef476f;
            --warning: #ffd166;
            --success: #06d6a0;
            --glass: rgba(255, 255, 255, 0.9);
            --glass-blur: blur(12px);
        }

        body { margin: 0; padding: 0; font-family: 'Mulish', 'Poppins', sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* --- 2D/3D SWITCHER --- */
        .view-toggle {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--glass); padding: 6px; border-radius: 50px;
            display: flex; gap: 5px; backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 10;
        }
        .view-btn {
            border: none; padding: 10px 24px; border-radius: 40px; cursor: pointer;
            font-weight: 700; font-size: 13px; background: transparent; color: #555; transition: 0.3s;
        }
        .view-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3); }

        /* --- SIDEBAR GLASSMORPHISM --- */
        .sidebar {
            position: absolute; top: 20px; left: 20px; width: 340px; max-height: 85vh;
            background: var(--glass); backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 20px; padding: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 15px; z-index: 5; border: 1px solid rgba(255,255,255,0.5);
        }

        .brand { display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 15px; }
        .brand-icon { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; font-size: 18px; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3); }
        
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background: rgba(255,255,255,0.6); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.8); }
        .stat-num { font-size: 22px; font-weight: 800; color: #2b2d42; }
        .stat-label { font-size: 11px; color: #8d99ae; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        .filter-header { font-size: 12px; font-weight: 800; color: #2b2d42; letter-spacing: 0.5px; margin-bottom: 5px; }
        .chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1px solid #e0e0e0; cursor: pointer; display: inline-block; margin: 2px; transition: 0.2s; background: white; color: #555; }
        .chip:hover { background: #f8f9fa; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        
        .location-list { overflow-y: auto; flex-grow: 1; padding-right: 5px; scrollbar-width: thin; }
        .loc-item { padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.5); margin-bottom: 8px; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .loc-item:hover { background: white; transform: translateX(4px); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .loc-item.risk-Tinggi { border-left-color: var(--danger); }
        .loc-item.risk-Sedang { border-left-color: var(--warning); }
        .loc-item.risk-Rendah { border-left-color: var(--success); }

        /* --- POPUP --- */
        .mapboxgl-popup-content { border-radius: 16px; padding: 0; overflow: hidden; max-width: 300px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); border: none; }
        .popup-banner { height: 100px; background-size: cover; background-position: center; position: relative; }
        .popup-banner::after { content: ''; position: absolute; bottom:0; left:0; width:100%; height:60%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        .popup-title { position: absolute; bottom: 10px; left: 15px; color: white; font-weight: 700; font-size: 16px; z-index: 2; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .popup-body { padding: 15px; background: white; }
        .btn-route {
            display: block; width: 100%; padding: 10px 0; margin-top: 12px;
            background: var(--success); color: white; text-align: center; border-radius: 8px;
            text-decoration: none; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s;
        }
        .btn-route:hover { background: #05b083; transform: translateY(-1px); }

        /* --- MARKER ANIMATION --- */
        .pulse { width: 16px; height: 16px; border-radius: 50%; background: var(--primary); box-shadow: 0 0 0 rgba(67, 97, 238, 0.4); animation: pulse 2s infinite; cursor: pointer; border: 2px solid white; }
        .pulse.risk-Tinggi { background: var(--danger); box-shadow: 0 0 0 rgba(239, 71, 111, 0.4); }
        .pulse.risk-Sedang { background: var(--warning); box-shadow: 0 0 0 rgba(255, 209, 102, 0.4); }
        .pulse.risk-Rendah { background: var(--success); box-shadow: 0 0 0 rgba(6, 214, 160, 0.4); }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,0,0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(0,0,0, 0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0, 0); } }

        /* --- MAPBOX OVERRIDES --- */
        .mapboxgl-ctrl-top-right { top: 70px; right: 10px; }
        .mapboxgl-ctrl-directions { min-width: 280px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        
        @media (max-width: 600px) {
            .sidebar { width: calc(100% - 40px); top: auto; bottom: 20px; max-height: 40vh; }
            .mapboxgl-ctrl-top-right { display: none; } /* Hide navigasi di HP agar tidak penuh */
            .view-toggle { top: 10px; }
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="view-toggle">
    <button class="view-btn" id="btn-2d" onclick="switchMode('2D')">2D Peta</button>
    <button class="view-btn active" id="btn-3d" onclick="switchMode('3D')">3D Kota</button>
</div>

<div class="sidebar">
    <div class="brand">
        <div class="brand-icon"><i class="fas fa-cube"></i></div>
        <div>
            <h3 style="margin:0; font-size:16px; color:#2b2d42;">SIG Ekraf Sidoarjo</h3>
            <small style="color:#777;">Pemetaan Potensi & Risiko</small>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-num" style="color:var(--primary)" id="total-count">0</div>
            <div class="stat-label">Total Unit</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color:var(--danger)" id="risk-count">0</div>
            <div class="stat-label">Risiko Tinggi</div>
        </div>
    </div>

    <div>
        <div class="filter-header">FILTER BERDASARKAN SEKTOR:</div>
        <div id="filters">
            <span class="chip active" onclick="filterData('all', this)">Semua</span>
            <span class="chip" onclick="filterData('Kuliner', this)">Kuliner</span>
            <span class="chip" onclick="filterData('Kriya', this)">Kriya</span>
            <span class="chip" onclick="filterData('Fesyen', this)">Fesyen</span>
            <span class="chip" onclick="filterData('Pariwisata', this)">Wisata</span>
        </div>
    </div>

    <div class="location-list" id="location-list">
        </div>
</div>

<script>
    // 1. CONFIG: ACCESS TOKEN
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWRlbnNldHlvOTEiLCJhIjoiY21qcng1NGNkNGs3bzNpb3dwN2F4d21iMiJ9.HuxCF8jOGISuEBdyjOJznw';

    // 2. SETUP MAP
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11', // Style peta cerah & modern
        center: [112.7150, -7.4500], // Sidoarjo center
        zoom: 12.5,
        pitch: 60, // Mulai dengan tampilan 3D
        bearing: -17,
        antialias: true
    });

    // 3. SETUP NAVIGASI (DIRECTIONS)
    const directions = new MapboxDirections({
        accessToken: mapboxgl.accessToken,
        unit: 'metric',
        profile: 'mapbox/driving',
        controls: { inputs: true, instructions: true, profileSwitcher: true },
        language: 'id'
    });
    map.addControl(directions, 'top-right');

    // 4. DATA STORE (DUMMY DATA - Nanti diganti Google Sheets)
    const dataStore = [
        { 
            id:1, 
            nama: "Kampung Batik Jetis", 
            sektor: "Kriya", 
            kec: "Sidoarjo", 
            lat: -7.4389, lng: 112.7150, 
            risk: "Rendah", 
            img: "https://images.unsplash.com/photo-1599691887340-9d5813d11b23?auto=format&fit=crop&w=600&q=80",
            desc: "Pusat batik tulis legendaris Sidoarjo sejak 1675."
        },
        { 
            id:2, 
            nama: "Sentra Kupang Lontong", 
            sektor: "Kuliner", 
            kec: "Candi", 
            lat: -7.4726, lng: 112.7128, 
            risk: "Sedang", 
            img: "https://images.unsplash.com/photo-1555396273-367ea4eb4db5?auto=format&fit=crop&w=600&q=80",
            desc: "Kawasan kuliner khas pesisir dengan olahan kerang."
        },
        { 
            id:3, 
            nama: "Creative Hub Waru", 
            sektor: "Fesyen", 
            kec: "Waru", 
            lat: -7.3511, lng: 112.7300, 
            risk: "Rendah", 
            img: "https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&w=600&q=80",
            desc: "Inkubator startup dan desainer muda."
        },
        { 
            id:4, 
            nama: "Industri Tas Tanggulangin", 
            sektor: "Fesyen", 
            kec: "Tanggulangin", 
            lat: -7.5056, lng: 112.6980, 
            risk: "Tinggi", 
            img: "https://images.unsplash.com/photo-1549448830-4e50889218d6?auto=format&fit=crop&w=600&q=80",
            desc: "Sentra kerajinan kulit yang membutuhkan revitalisasi pasar."
        },
        { 
            id:5, 
            nama: "Wisata Bahari Tlocor", 
            sektor: "Pariwisata", 
            kec: "Jabon", 
            lat: -7.5670, lng: 112.8360, 
            risk: "Sedang", 
            img: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=600&q=80",
            desc: "Dermaga wisata menuju Pulau Lusi (Lumpur Sidoarjo)."
        }
    ];

    // LOAD EVENT
    map.on('load', () => {
        // Tambah Layer Gedung 3D
        const layers = map.getStyle().layers;
        const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;
        map.addLayer({
            'id': '3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 13,
            'paint': {
                'fill-extrusion-color': '#aaa',
                'fill-extrusion-height': ['get', 'height'],
                'fill-extrusion-base': ['get', 'min_height'],
                'fill-extrusion-opacity': 0.6
            }
        }, labelLayerId);

        // Render Data Awal
        renderPoints(dataStore);
        updateStats(dataStore);
    });

    let currentMarkers = [];

    // FUNGSI RENDER MAP POINTS & SIDEBAR LIST
    function renderPoints(data) {
        // Bersihkan marker lama
        currentMarkers.forEach(m => m.remove());
        currentMarkers = [];
        
        const listEl = document.getElementById('location-list');
        listEl.innerHTML = '';

        data.forEach(item => {
            // 1. Buat Marker di Peta
            const el = document.createElement('div');
            el.className = `pulse risk-${item.risk}`; // Class warna berdasarkan risiko
            
            const marker = new mapboxgl.Marker(el)
                .setLngLat([item.lng, item.lat])
                .setPopup(createPopup(item))
                .addTo(map);
            currentMarkers.push(marker);

            // 2. Buat Item di Sidebar
            const listItem = document.createElement('div');
            listItem.className = `loc-item risk-${item.risk}`;
            listItem.innerHTML = `
                <div style="font-weight:700; color:#333;">${item.nama}</div>
                <div style="font-size:11px; color:#666; display:flex; justify-content:space-between; margin-top:4px;">
                    <span><i class="fas fa-tag"></i> ${item.sektor}</span>
                    <span>${item.kec}</span>
                </div>
            `;
            // Klik item sidebar -> terbang ke lokasi
            listItem.addEventListener('click', () => {
                map.flyTo({ center: [item.lng, item.lat], zoom: 16, pitch: 60 });
                marker.togglePopup();
            });
            listEl.appendChild(listItem);
        });
    }

    // FUNGSI MEMBUAT POPUP HTML
    function createPopup(item) {
        return new mapboxgl.Popup({ offset: 25 }).setHTML(`
            <div class="popup-banner" style="background-image: url('${item.img}');">
                <div class="popup-title">${item.nama}</div>
            </div>
            <div class="popup-body">
                <div style="font-size:11px; margin-bottom:8px;">
                    <span style="background:#eee; padding:2px 6px; border-radius:4px;">${item.sektor}</span>
                    <span style="float:right; font-weight:bold; color:${getRiskColor(item.risk)}">${item.risk} Risk</span>
                </div>
                <p style="margin:0; font-size:12px; line-height:1.4; color:#555;">${item.desc}</p>
                <button class="btn-route" onclick="startNavigation(${item.lng}, ${item.lat})">
                    <i class="fas fa-location-arrow"></i> Rute ke Lokasi
                </button>
            </div>
        `);
    }

    // HELPER: Warna Risiko
    function getRiskColor(risk) {
        if(risk === 'Tinggi') return '#ef476f';
        if(risk === 'Sedang') return '#ffd166';
        return '#06d6a0';
    }

    // NAVIGASI (RUTE)
    window.startNavigation = function(destLng, destLat) {
        directions.setDestination([destLng, destLat]);
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const userLng = position.coords.longitude;
                const userLat = position.coords.latitude;
                directions.setOrigin([userLng, userLat]);
                
                // Animasi terbang ke posisi user agar rute terlihat
                map.flyTo({ center: [userLng, userLat], zoom: 13, pitch: 0 });
            }, () => {
                alert("Mohon izinkan akses Lokasi (GPS) browser Anda.");
            });
        } else {
            alert("Browser tidak mendukung Geolocation.");
        }
    }

    // MODE 2D / 3D
    window.switchMode = function(mode) {
        document.getElementById('btn-2d').classList.remove('active');
        document.getElementById('btn-3d').classList.remove('active');
        document.getElementById('btn-' + mode.toLowerCase()).classList.add('active');

        if (mode === '2D') {
            map.easeTo({ pitch: 0, bearing: 0, duration: 1200 });
        } else {
            map.easeTo({ pitch: 60, bearing: -17, duration: 1200 });
        }
    }

    // FILTER LOGIC
    window.filterData = function(cat, el) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        
        const filtered = (cat === 'all') ? dataStore : dataStore.filter(d => d.sektor === cat);
        renderPoints(filtered);
    }

    // UPDATE STATISTIK
    function updateStats(data) {
        document.getElementById('total-count').innerText = data.length;
        document.getElementById('risk-count').innerText = data.filter(d => d.risk === 'Tinggi').length;
    }
</script>

</body>
</html>
